<!-- BeginDsi "dsi/head.html" -->
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Embedthis Appweb 4.6.5 Documentation</title>
    <meta name="keywords" content="embedded web server, web server software, embedded HTTP, application web server, 
        embedded server, small web server, HTTP server, library web server, library HTTP, HTTP library" />
    <meta name="description" content="Embedthis Sofware provides commercial and open source embedded web servers for 
        devices and applications." />
	<meta name="robots" content="index,follow" />
	<link href="../../../doc.css" rel="stylesheet" type="text/css" />
	<link href="../../../print.css" rel="stylesheet" type="text/css" media="print"/>
    <!--[if IE]>
    <link href="../../../iehacks.css" rel="stylesheet" type="text/css" />
    <![endif]-->
</head>

<body>
    <div class="top">
        <a class="logo" href="http://appwebserver.org/">&nbsp;</a>
        <div class="topRight">
            <div class="search">
                <div id="cse-search-form"></div>
                <div class="version">Embedthis Appweb 4.6.5</div>
            </div>
        </div>
        <div class="crumbs">
            <a href="../../../index.html">Home</a>
<!-- EndDsi -->
             &gt; <a href="index.html">ESP Guide</a> &gt; <b>ESP MVC Tour</b>
        </div>
    </div>
    <div class="content">
        <div class="contentRight">
            <h1>Quick Nav</h1>
            <ul class="nav">
                <li><a href="#blog">Blog App</a></li>
                <li><a href="#create">Creating a New App</a></li>
                <li><a href="#run">Run the App</a></li>
                <li><a href="#scaffolds">Scaffolds</a></li>
                <li><a href="#newPosts">Create New Posts</a></li>
                <li><a href="#homePage">Edit the Home Page</a></li>
                <li><a href="#validations">Validations</a></li>
                <li><a href="#learn">Learn More</a></li>
            </ul>
<!-- BeginDsi "dsi/espSeeAlso.html" -->
		        <h1>See Also</h1>
		        <ul class="nav">
		          <li><a href="../../../guide/esp/users/overview.html">ESP Overview</a></li>
		          <li><a href="../../../guide/esp/users/pages.html">ESP Pages</a></li>
		          <li><a href="../../../guide/esp/users/config.html">ESP Configuration Directives</a></li>
		          <li><a href="../../../guide/esp/users/controllers.html">ESP Controllers and Actions</a></li>
		          <li><a href="../../../guide/esp/users/mvc.html">ESP MVC</a></li>
		          <li><a href="../../../guide/esp/users/pages-tour.html">ESP Page Tour</a></li>
		          <li><a href="../../../guide/esp/users/generator.html">ESP Generator</a></li>
		          <li><a href="../../../guide/esp/users/database.html">ESP Database Interface</a></li>
		          <li><a href="../../../guide/appweb/users/caching.html">Caching Responses</a></li>
		        </ul>
<!-- EndDsi -->
        </div>
        <div class="contentLeft">
            <h1>ESP MVC Tour</h1>
            <p>This quick tour of the ESP MVC Framework provides an overview of the ESP generator for 
            Model-View-Controller applications. The generated application will use the 
            <a href="http://angularjs.org">AngularJS</a> client-side library.</p>
            <p>Before starting, first make sure you have read the <a href="../../appweb/users/quickStart.html">Quick Start</a>,
            and the <a href="pages-tour.html">ESP Pages Tour</a> and that you have ESP installed on your system so you
            can type along as you go. This tour uses the <em><a href="generator.html">esp</a></em> application
            generator.</p>
            <a id="blog"></a>
            <a id="create"></a>
            <h2 class="section">Creating a New Application</h2>
            <p>To create a new ESP application, you will use <em>esp</em>, the ESP application generator
            program. Type the following esp command in a command terminal window:</p>
            <pre>
home&gt; <b>mkdir blog
cd blog
esp install esp-angular-mvc</b>
</pre>
            <p>This simple command accomplished quite a bit. It first created a new directory called <b>blog</b> for
            the application, and then created subdirectories for various parts of the application. Initially, some of
            these directories are empty, but they will be used as your application grows.</p>
            <p>The command created two configuration files that control how your application will run. The first, 
            <em>appweb.conf</em> configures Appweb to host your application. The second, <em>package.json</em> is the
            ESP configuration file for your application. </p>
            <h2>Conventions</h2>
            <p>The ESP web framework follows the <i>"convention over
            configuration"</i> philosophy popularized by <a href="http://www.rubyonrails.org">Ruby on Rails</a>. This
            means that ESP adopts certain conventions about where files and directories should be placed and about
            how names are used. If you work with these conventions, then you need to do little or no configuration.
            Things will just work.</p>
            <p>Here are the most important directories:</p>
            <table title="directories">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>cache</td>
                        <td>Cached controller and view modules</td>
                    </tr>
                    <tr>
                        <td>client</td>
                        <td>Client-side scripts, pages and style-sheets</td>
                    </tr>
                    <tr>
                        <td>controllers</td>
                        <td>Application controller code</td>
                    </tr>
                    <tr>
                        <td>db</td>
                        <td>Database file and database initialization scripts</td>
                    </tr>
                    <tr>
                        <td>layouts</td>
                        <td>Server-side web page layout templates</td>
                    </tr>
                    <tr>
                        <td>views</td>
                        <td>Server-side generated web pages</td>
                    </tr>
                </tbody>
            </table>
            <p>See the "<a href="generator.html">esp</a>" command documentation for an explanation of the other generated
            directories.</p>
            
            <a id="run"></a>
            <h2 class="section">Running your Application</h2>
            <p>You can immediately run your application after generation. The <em>esp</em> command will invoke appweb
            to run your application: </p>
            <pre>
home&gt; cd blog
home/blog&gt;<b> esp run</b>
       [RUN] appweb -v
       appweb: 2: Configuration for Embedthis Appweb
appweb: 2: ---------------------------------------------
appweb: 2: Version:            4.4.0-0
appweb: 2: BuildType:          Debug
appweb: 2: CPU:                x64
appweb: 2: OS:                 macosx
appweb: 2: Host:               magnetar.local
appweb: 2: Directory:          /Users/mob/git/apps/demo
appweb: 2: Configure:          me configure
appweb: 2: ---------------------------------------------
appweb: 2: Using config file: "/Users/mob/git/apps/demo/appweb.conf"
appweb: 2: Loading native module libmod_esp.dylib
appweb: 2: Loading native module app_d9ae850162d60511cf2c50ebea6595b1.dylib
appweb: 2: Started HTTP  service on "127.0.0.1:4800"
appweb: 1: Started at Mon Sep 23 12:53:26 2014 PDT with max 5 threads
</pre>
            <p>Then enter <em>localhost:4000</em> in your browser. You should see your first application home
            page.</p>
            
 
            <a id="scaffolds"></a>
            <h2>Scaffolds</h2>
            <p>Scaffolding is a quick way to generate pieces of your application. The <em>esp</em> command can generate
            database tables, views and controllers for you. The command below will create a <em>post</em> database table
            with a blog post title and post comment body. The <em>title</em> is a string data type and the <em>body</em> is a
            multi-line text field.</p>
            <pre>
home/blog&gt; <b>esp generate scaffold post title:string body:text</b>
    [Create] Directory: controllers
    [Create] controllers/post.c
    [Create] Directory: client/app/post
    [Create] client/app/post/PostControl.js
    [Create] client/app/post/post-list.html
    [Create] client/app/post/post-edit.html
    [Create] client/app/post/Post.js
    [Create] Directory: db/migrations
    [Create] db/migrations/201409231500250_create_scaffold_post.c
   [Compile] db/migrations/201409231500250_create_scaffold_post.c
   [Migrate] Apply 201409231500250_create_scaffold_post.c 
      [Task] All migrations applied
      [Task] Complete
</pre>
            <p>This command created:</p>
            <ul>
                <li>A server-side post Controller (post.c)</li>
                <li>A client-side post Controller (PostControl.js)</li>
                <li>A client-side HTML views for listing posts (post-list) and editing posts (post-edit).</li>
                <li>A client-side post Model to hold post data.</li>
                <li>A database migration to create the post database table.</li>
            </ul>
            <p>The command also run the migration to create the database and table.</p>
            <p>Now if you set your browser to the home page, you will now see an empty listing of blog posts.
            <img src="../../../images/esp/mvc-tour/post-list.png" alt="postList" class="bare-screen" /> 
            
            <a id="newPosts"></a></p>
            <h2 class="section">Create New Posts</h2>
            <p>The New Post button directs your browser to the <em>/server/post/</em> URI. This form is being
            rendered on the client from the client/app/post/post-edit.html template. Behind the scenes, the 
            browser asks for the <em>/server/post/init</em> URI to determine what are the required input fields 
            for a post.</p>
            <img src= "../../../images/esp/mvc-tour/create.png" alt="createPost" class="bare-screen" />
            <p>Fill in the input fields and click OK to add the new blog post.</p>
            
            <img src= "../../../images/esp/mvc-tour/post-list-2.png" alt="postList" class="bare-screen" />
            <p>The home page is now updated with the first post.  You can click on the post title or body
            to edit its contents. This will run the same post-edit.html template that was used to create the post.</p>
            <h2 class=section>On the Server</h2>
            <p>When <em>OK</em> button is clicked to create a post, the browser invokes the
            <em>/server/post</em> URI with the HTTP "POST" method to create the blog post. The Appweb server
            parses this URI and and selects the appropriate request route and handler for the request. It 
            then identifies <em>post</em> as the name of the server-side controller invokes the <em>createPost</em>
            action routine to service the request. The controller is automatically compiled and loaded if required.
            <p>A controller file typically defines many such C functions called actions, that are bound to specific URIs
            via Appweb routes. Actions are defined using the <em>espDefineAction</em> API in the initialization 
            function of the controller.</p>
            <p>A minimal post controller file looks like this:</p>
            <pre>
#include "esp.h"
static void createPost() { 
    EdiRec *rec = createRec("post", params());
    renderResult(updateRec(rec));
}
ESP_EXPORT int esp_controller_blog_post(EspRoute *eroute) 
{
    espDefineAction(route, "post-create", createPost);
    return 0;
}
</pre>
            <h3>Actions</h3>
            <p>The job of the action is to respond to the request and generate the response via views for the
            client. Here is the <em>list</em> action in the generated <em>post</em> controller.</p>
            <pre>
static void listPost() { 
    renderGrid(readTable("post"));
}
</pre>
            <p>The <em>list</em> action reads the post table and then renders the table data and schema as a JSON
            response. The client interprets this JSON data an applies it to the client-side model. Angular uses this
            model and "data-binding" to paste the data, somewhat auto-magically into the HTML page. </p>
            
            <h2>Code Errors</h2>
            <p>What happens if you make a mistake entering the embedded "C" code in your controller or in an ESP web page. 
            Say you forgot the semicolon in the last example. You will see an error like this in your browser:</p>
            <img src="../../../images/esp/mvc-tour/error.png" alt="homeLink" class="bare-screen" /> 
            <p>If you look in the appweb console log, you will see details about the request that failed.</p>
            <pre>
appweb: 2: Error: Cannot run command clang -c -DME_DEBUG -g -Wall -DPIC \
  -fPIC -arch x86_64 /home/apps/blog/controllers/post.c -o \
  /home/apps/blog/cache/controller_74bffd199d8b4c675e1f693d86eef471.o
/home/apps/blog/controllers/post.c:21:38: error: expected ';' after expression:
    renderGrid(readTable("post"))
                                 ^</pre>
            
            <a id="validations">
            </a>
            <h2 class="section">Validations</h2>
            <p>Complete validation of all user entered data is essential for a robust and secure application. The 
            validation may be performed at the client, but must also always be fully implemented on the server incase
            the client or network connection is compromised. ESP provides flexible validation methods to help 
            ensure the data you save at the server is correct.</p>
            <p>You can add calls to validate record data before it is saved to the database. To do this, edit the
            <em>controllers/post.c</em> file and add calls to <a 
            href="../../../api/edi.html#group___edi_1ga64cb0410a70843250c9826e8d12e3944">ediAddValidation</a>.</p>
            <pre>
ESP_EXPORT int esp_controller_post(EspRoute *eroute, MprModule *module) 
{
    <b>Edi *edi;</b>
    /* Existing code */
    <b>edi = getDatabase();
    ediAddValidation(edi, "present", "post", "title", 0);
    ediAddValidation(edi, "present", "post", "body", 0);
    ediAddValidation(edi, "unique", "post", "title", 0);</b>
    return 0;
}
</pre>
            <p>This will cause the database to automatically ensure that the <em>title</em> and <em>body</em> fields are
            not blank and that the <em>title</em> is unique in the post database table.</p>
           
            <p>If you click OK in the Post <em>edit</em> web page without entering any data
            you will see the following:</p>
            
            <img src="../../../images/esp/mvc-tour/validate.png" alt="validate" class="bare-screen" />
            <p>This automatically identified the input fields in error and generated a summary of the errors above the
            form. Of course, this default error highlighting behavior can be overridden if desired by modifying the
            application style sheets.<p>
           
            <p>Other validation types include: checkNumber, checkBoolean, checkDate and checkFormat.
            You can also define new validation types by calling 
            <a href="../../../api/edi.html#group___edi_service_1ga889df64bdd239f71c66b4fa920be8f46">ediDefineValidation</a>.
            <a id="homePage"></a>
            <h2>Edit the Home Page</h2>
            <p>ESP applications based on Angular use a single home page that applies different view templates to modify
            the content. Consequently, the index.esp home page is typically also the master application layout page. 
            Modifying index.esp will modify all the views presented to the client.</p>
            <a id="learn"></a>
            <h2 class="section">Learn More ...</h2>
            <p>That concludes the a quick tour through some of the capabilities of the ESP web framework.</p>
            <p>To learn more, please read:
            <ul>
                <li><a href="index.html">ESP Documentation</a></li>
                <li><a href="pages-tour.html">ESP Pages Tour</a></li>
            </ul>
            <p>You may also like to ask questions at the <a href="http://www.ejscript.org/forum/">ESP Support Forum</a>.</p>
        </div>
    </div>
<!-- BeginDsi "dsi/bottom.html" -->
	<div class="bottom">
		<p class="footnote"> 
            <a href="../../../product/copyright.html" >&copy; Embedthis Software LLC, 2003-2014.
            All rights reserved. Embedthis, Appweb, ESP, Ejscript and Embedthis GoAhead are trademarks of Embedthis Software LLC.</a>
		</p>
	</div>
</body>
</html>
